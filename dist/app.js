!function(t){var e={};function i(s){if(e[s])return e[s].exports;var r=e[s]={i:s,l:!1,exports:{}};return t[s].call(r.exports,r,r.exports,i),r.l=!0,r.exports}i.m=t,i.c=e,i.d=function(t,e,s){i.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:s})},i.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},i.t=function(t,e){if(1&e&&(t=i(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var s=Object.create(null);if(i.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var r in t)i.d(s,r,function(e){return t[e]}.bind(null,r));return s},i.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return i.d(e,"a",e),e},i.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},i.p="",i(i.s=0)}([function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const s=i(1),r=i(2),n=i(3),o=i(4),a=i(5),c=i(6),d=s({logger:!0});d.register(r),d.register(n,{client:new o.Client({node:a.env.ELASTIC})}),d.register(c.AppModule.footRoot),d.listen(3e3,"0.0.0.0",(t,e)=>{t&&(d.log.error(t),process.exit(1)),d.log.info(`server listening on ${e}`)})},function(t,e){t.exports=require("fastify")},function(t,e){t.exports=require("fastify-compress")},function(t,e){t.exports=require("fastify-elasticsearch")},function(t,e){t.exports=require("@elastic/elasticsearch")},function(t,e){t.exports=require("process")},function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const s=i(7),r=i(11),n=i(12),o=i(13);class a{constructor(t){this.fastify=t}static footRoot(t,e,i){const s=new a(t);s.setProviders(),s.onInit(),s.setRoute(),s.onChange(),i()}setProviders(){this.config=new o.ConfigService(__dirname),this.jobs=new s.JobsService,this.logs=new r.LogsService(this.fastify,"schedule-service")}onInit(){const t=this.config.get();for(const e in t)t.hasOwnProperty(e)&&this.jobs.put(t[e])}setRoute(){n.api(this.fastify,this.jobs,this.config,this.logs)}onChange(){this.jobs.runtime.on("default",t=>{this.logs.add({type:"run",identity:t.identity,result:t.result,time:(new Date).getTime()})}),this.jobs.runtime.on("errors",t=>{this.logs.add({type:"error",identity:t.identity,result:t.result,time:(new Date).getTime()})})}}e.AppModule=a},function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const s=i(8),r=i(9),n=i(10);e.JobsService=class{constructor(){this.runtime=new n,this.jobs={},this.cronJobs=new Map}getJobs(){return this.jobs}get(t){if(!this.cronJobs.has(t))return!1;const e=this.cronJobs.get(t);return Object.assign(this.jobs[t],{running:e.running,nextDate:e.nextDate(),lastDate:e.lastDate()})}put(t){this.jobs.hasOwnProperty(t.identity)&&this.delete(t.identity),this.jobs[t.identity]=t;const e=new s.CronJob(t.time,()=>{try{this.runtime.emit("default",{identity:t.identity,result:r.execSync(t.bash).toString()})}catch(e){this.runtime.emit("error",{identity:t.identity,result:e.message}),this.stop(t.identity)}},null,t.start,t.zone);return this.cronJobs.set(t.identity,e),this.jobs.hasOwnProperty(t.identity)&&this.cronJobs.has(t.identity)}delete(t){return!this.cronJobs.has(t)||(this.cronJobs.get(t).stop(),this.cronJobs.delete(t)&&Reflect.deleteProperty(this.jobs,t))}start(t){if(!this.cronJobs.has(t))return!1;const e=this.cronJobs.get(t);return e.start(),e.running}stop(t){if(!this.cronJobs.has(t))return!1;const e=this.cronJobs.get(t);return e.stop(),e.running}}},function(t,e){t.exports=require("cron")},function(t,e){t.exports=require("child_process")},function(t,e){t.exports=require("events")},function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0});e.LogsService=class{constructor(t,e){this.fastify=t,this.index=e,this.client=t.elastic}async add(t){return await this.client.index({index:this.index,body:t})}async search(t,e,i,s,r){const n={bool:{must:[]}};return t&&n.bool.must.push({match:{type:t}}),e&&n.bool.must.push({match:{identity:e}}),i&&n.bool.must.push({range:{time:i}}),await this.client.search({index:this.index,body:{query:n,size:s,from:r,sort:{time:{order:"desc"}}}})}async clear(t){return await this.client.delete_by_query({index:this.index,body:{query:{match:{identity:t}}}})}}},function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0});e.api=(t,e,i,s)=>{function r(){i.set(e.getJobs())}t.post("/all",async(t,i)=>{const s=[];for(const t in e.getJobs())e.getJobs().hasOwnProperty(t)&&s.push(t);i.send({error:0,data:s})}),t.post("/lists",{schema:{body:{required:["identity"],properties:{identity:{type:"array"}}}}},async(t,i)=>{const s=t.body;i.send({error:0,data:s.identity.map(t=>e.get(t))})}),t.post("/get",{schema:{body:{required:["identity"],properties:{identity:{type:"string"}}}}},async(t,i)=>{const s=t.body,r=e.get(s.identity);r?i.send({error:0,data:r}):i.send({error:1,msg:"not exists"})}),t.post("/put",{schema:{body:{required:["identity","time","bash","start","zone"],properties:{identity:{type:"string"},time:{type:"string"},bash:{type:"string"},start:{type:"boolean"},zone:{type:"string"}}}}},async(t,i)=>{const n=t.body,o=e.put(n),a=await s.add({type:"put",identity:n.identity,body:n,status:o,time:(new Date).getTime()});r(),o&&201===a.statusCode?i.send({error:0,msg:"ok"}):i.send({error:1,msg:"failed"})}),t.post("/delete",{schema:{body:{required:["identity"],properties:{identity:{type:"string"}}}}},async(t,i)=>{const n=t.body,o=e.delete(n.identity),a=await s.add({type:"delete",identity:n.identity,body:n,status:o,time:(new Date).getTime()});r(),o&&201===a.statusCode?i.send({error:0,msg:"ok"}):i.send({error:1,msg:"failed"})}),t.post("/status",{schema:{body:{required:["identity","status"],properties:{identity:{type:"string"},status:{type:"boolean"}}}}},async(t,i)=>{const r=t.body;r.status?e.start(r.identity):e.stop(r.identity),201===(await s.add({type:"status",identity:r.identity,body:r,time:(new Date).getTime()})).statusCode?i.send({error:0,msg:"ok"}):i.send({error:1,msg:"failed"})}),t.post("/search",{schema:{body:{required:["identity","time","limit","skip"],properties:{type:{type:"string",enum:["put","delete","status","run","error"]},identity:{type:"string"},create_time:{type:"object"},limit:{type:"number",minimum:1,maximum:50},skip:{type:"number",minimum:0}}}}},async(t,e)=>{const i=t.body,r=await s.search(i.type,i.identity,i.time,i.limit,i.skip);e.send({error:0,data:r.body})}),t.post("/clear",{schema:{body:{required:["identity"],properties:{identity:{type:"string"}}}}},async(t,e)=>{const i=t.body;200===(await s.clear(i.identity)).statusCode?e.send({error:0,msg:"ok"}):e.send({error:1,msg:"failed"})})}},function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const s=i(14),r=i(15);e.ConfigService=class{constructor(t){this.file=r.join(t,"data","config.json"),s.existsSync(this.file)?this.config=JSON.parse(s.readFileSync(this.file).toString()):s.writeFileSync(this.file,JSON.stringify({}))}get(){return this.config}set(t){s.writeFileSync(this.file,JSON.stringify(t)),this.config=t}}},function(t,e){t.exports=require("fs")},function(t,e){t.exports=require("path")}]);