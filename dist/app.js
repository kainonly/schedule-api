!function(e){var t={};function i(s){if(t[s])return t[s].exports;var n=t[s]={i:s,l:!1,exports:{}};return e[s].call(n.exports,n,n.exports,i),n.l=!0,n.exports}i.m=e,i.c=t,i.d=function(e,t,s){i.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:s})},i.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},i.t=function(e,t){if(1&t&&(e=i(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var s=Object.create(null);if(i.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var n in e)i.d(s,n,function(t){return e[t]}.bind(null,n));return s},i.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return i.d(t,"a",t),t},i.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},i.p="",i(i.s=1)}([function(e,t){e.exports=require("process")},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const s=i(2),n=i(3),r=i(4),o=i(5),c=i(0),a=i(6),d=s({logger:!0});d.register(n),d.register(r,{client:new o.Client({node:c.env.ELASTIC})}),d.register(a.AppModule.footRoot),d.listen(3e3,"0.0.0.0",(e,t)=>{e&&(d.log.error(e),process.exit(1)),d.log.info(`server listening on ${t}`)})},function(e,t){e.exports=require("fastify")},function(e,t){e.exports=require("fastify-compress")},function(e,t){e.exports=require("fastify-elasticsearch")},function(e,t){e.exports=require("@elastic/elasticsearch")},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const s=i(7),n=i(8),r=i(0),o=i(9),c=i(12),a=i(14),d=i(15);class u{constructor(e){this.fastify=e,this.events=new s.EventEmitter}static footRoot(e,t,i){const s=new u(e);s.setProviders(),s.onInit(),s.setRoute(),i()}setProviders(){this.config=new o.ConfigService(__dirname),this.tasks=new c.TasksService(this.events),this.logs=new a.LogsService(this.fastify,r.env.ELASTIC_INDEX?r.env.ELASTIC_INDEX:"schedule-service")}onInit(){const e=this.config.get();for(const t in e)e.hasOwnProperty(t)&&this.tasks.put(e[t]);this.events.on("tick",async e=>{try{const t=await n.post(e.url,{json:!0,headers:e.headers,body:e.body});this.logs.add({type:"success",identity:e.identity,url:t.requestUrl,headers:t.headers,body:t.body,time:(new Date).getTime()})}catch(t){this.logs.add({type:"error",identity:e.identity,message:t.message,time:(new Date).getTime()})}})}setRoute(){d.api(this.fastify,this.tasks,this.config,this.logs)}}t.AppModule=u},function(e,t){e.exports=require("events")},function(e,t){e.exports=require("got")},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const s=i(10),n=i(11);t.ConfigService=class{constructor(e){const t=n.join(e,"data");s.existsSync(t)||s.mkdirSync(t),this.file=n.join(t,"config.json"),s.existsSync(this.file)?this.config=JSON.parse(s.readFileSync(this.file).toString()):s.writeFileSync(this.file,JSON.stringify({}))}get(){return this.config}set(e){s.writeFileSync(this.file,JSON.stringify(e)),this.config=e}}},function(e,t){e.exports=require("fs")},function(e,t){e.exports=require("path")},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const s=i(13);t.TasksService=class{constructor(e){this.events=e,this.tasks={},this.cronJobs=new Map}getTasks(){return this.tasks}get(e){if(!this.cronJobs.has(e))return!1;const t=this.cronJobs.get(e);return Object.assign(this.tasks[e],{running:t.running,nextDate:t.nextDate(),lastDate:t.lastDate()})}put(e){this.tasks.hasOwnProperty(e.identity)&&this.delete(e.identity),Reflect.set(this.tasks,e.identity,e);const t=new s.CronJob(e.cron_time,()=>{this.events.emit("tick",e)},null,e.start,e.time_zone);return this.cronJobs.set(e.identity,t),this.tasks.hasOwnProperty(e.identity)&&this.cronJobs.has(e.identity)}delete(e){return!this.cronJobs.has(e)||(this.cronJobs.get(e).stop(),this.cronJobs.delete(e)&&Reflect.deleteProperty(this.tasks,e))}start(e){if(!this.cronJobs.has(e))return!1;const t=this.cronJobs.get(e);return t.start(),t.running}stop(e){if(!this.cronJobs.has(e))return!1;const t=this.cronJobs.get(e);return t.stop(),t.running}}},function(e,t){e.exports=require("cron")},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.LogsService=class{constructor(e,t){this.fastify=e,this.index=t,this.client=e.elastic}async add(e){return await this.client.index({index:this.index,body:e})}async search(e,t,i,s,n){const r={bool:{must:[]}};return e&&r.bool.must.push({match:{type:e}}),t&&r.bool.must.push({match:{identity:t}}),i&&r.bool.must.push({range:{time:i}}),await this.client.search({index:this.index,body:{query:r,size:s,from:n,sort:{time:{order:"desc"}}}})}async clear(e){return await this.client.delete_by_query({index:this.index,body:{query:{match:{identity:e}}}})}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const s=i(16);t.api=(e,t,i,n)=>{function r(){i.set(t.getTasks())}e.post("/all",async(e,i)=>{const s=[],n=t.getTasks();for(const e in n)n.hasOwnProperty(e)&&s.push(e);i.send({error:0,data:s})}),e.post("/lists",{schema:{body:{required:["identity"],properties:{identity:{type:"array"}}}}},async(e,i)=>{const s=e.body;i.send({error:0,data:s.identity.map(e=>t.get(e))})}),e.post("/get",{schema:{body:{required:["identity"],properties:{identity:{type:"string"}}}}},async(e,i)=>{const s=e.body,n=t.get(s.identity);n?i.send({error:0,data:n}):i.send({error:1,msg:"not exists"})}),e.post("/put",{schema:{body:{required:["identity","cron_time","url","time_zone"],properties:{identity:{type:"string"},cron_time:{type:"string"},url:{type:"string"},headers:{type:"object"},body:{type:"object"},start:{type:"boolean"},time_zone:{type:"string"}}}}},async(e,i)=>{const o=e.body;if(6!==o.cron_time.split(" ").filter(e=>""!==e).length)return void i.send({error:1,msg:"Cron job failures can be disastrous!"});Reflect.set(o,"start",!o.start||o.start),s.findTimeZone(o.time_zone);const c=t.put(o),a=await n.add({type:"put",identity:o.identity,body:o,action:c,time:(new Date).getTime()});c&&201===a.statusCode?(r(),i.send({error:0,msg:"ok"})):i.send({error:1,msg:"failed"})}),e.post("/delete",{schema:{body:{required:["identity"],properties:{identity:{type:"string"}}}}},async(e,i)=>{const s=e.body,o=t.delete(s.identity),c=await n.add({type:"delete",identity:s.identity,body:s,action:o,time:(new Date).getTime()});o&&201===c.statusCode?(r(),i.send({error:0,msg:"ok"})):i.send({error:1,msg:"failed"})}),e.post("/running",{schema:{body:{required:["identity","running"],properties:{identity:{type:"string"},running:{type:"boolean"}}}}},async(e,i)=>{const s=e.body;s.running?t.start(s.identity):t.stop(s.identity),201===(await n.add({type:"running",identity:s.identity,body:s,time:(new Date).getTime()})).statusCode?i.send({error:0,msg:"ok"}):i.send({error:1,msg:"failed"})}),e.post("/search",{schema:{body:{required:["identity","time","limit","skip"],properties:{type:{type:"string",enum:["put","delete","running","success","error"]},identity:{type:"string"},create_time:{type:"object"},limit:{type:"number",minimum:1,maximum:50},skip:{type:"number",minimum:0}}}}},async(e,t)=>{const i=e.body,s=await n.search(i.type,i.identity,i.time,i.limit,i.skip);t.send({error:0,data:s.body})}),e.post("/clear",{schema:{body:{required:["identity"],properties:{identity:{type:"string"}}}}},async(e,t)=>{const i=e.body;200===(await n.clear(i.identity)).statusCode?t.send({error:0,msg:"ok"}):t.send({error:1,msg:"failed"})})}},function(e,t){e.exports=require("timezone-support")}]);