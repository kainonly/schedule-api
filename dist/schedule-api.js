!function(t){var e={};function i(s){if(e[s])return e[s].exports;var n=e[s]={i:s,l:!1,exports:{}};return t[s].call(n.exports,n,n.exports,i),n.l=!0,n.exports}i.m=t,i.c=e,i.d=function(t,e,s){i.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:s})},i.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},i.t=function(t,e){if(1&e&&(t=i(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var s=Object.create(null);if(i.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var n in t)i.d(s,n,function(e){return t[e]}.bind(null,n));return s},i.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return i.d(e,"a",e),e},i.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},i.p="",i(i.s=0)}([function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const s=i(1),n=i(2),r=i(3),o=i(4),a=i(5),u=s({logger:!!o.env.LOGGER&&o.env.LOGGER});u.register(n),u.register(r.default,{name:o.env.STORAGE}),u.register(a.AppModule.footRoot),u.listen(3e3,"0.0.0.0",(t,e)=>{t&&(u.log.error(t),process.exit(1)),u.log.info(`server listening on ${e}`)})},function(t,e){t.exports=require("fastify")},function(t,e){t.exports=require("fastify-compress")},function(t,e){t.exports=require("fastify-pouchdb")},function(t,e){t.exports=require("process")},function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const s=i(6),n=i(7),r=i(11);class o{constructor(t){this.fastify=t}static footRoot(t,e,i){const s=new o(t);s.setProviders(),s.onInit(),s.setRoute(),s.onChange(),i()}setProviders(){this.jobs=new n.JobsService,this.storage=new s.StorageService(this.fastify)}onInit(){this.storage.get("jobs").then(t=>{if(null===t)return;const{data:e}=t;for(const t in e)e.hasOwnProperty(t)&&this.jobs.put(e[t])}).catch(t=>{console.log(t)})}setRoute(){r.api(this.fastify,this.jobs,this.storage)}onChange(){this.jobs.runtime.on("default",t=>{this.storage.logging({type:"run",identity:t.identity,output:t.output,status:!0,create_time:(new Date).getTime()})}),this.jobs.runtime.on("errors",t=>{this.storage.logging({type:"error",identity:t.identity,output:t.output,status:!0,create_time:(new Date).getTime()})})}}e.AppModule=o},function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0});e.StorageService=class{constructor(t){this.fastify=t,this.database=t.pouchdb,this.database.createIndex({index:{fields:["type","identity"],name:"logging",ddoc:"logging",type:"json"}}).then(t=>{"created"===t.result&&console.debug("index create success!")}).catch(t=>{console.log(t)})}async get(t){try{return await this.database.get(t)}catch(t){return"missing"===t.message&&null}}async add(t,e){try{const i=await this.database.get(t),s=Object.assign({_id:t,_rev:i._rev},e);return await this.database.put(s)}catch(i){return"missing"===i.message&&await this.database.put(Object.assign({_id:t},e))}}async logging(t){return await this.database.post({type:t.type,identity:t.identity,output:t.output,create_time:t.create_time})}async find(t,e,i,s){return{lists:(await this.database.find({selector:{type:t,identity:e},limit:i,skip:s,use_index:"logging"})).docs}}}},function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const s=i(8),n=i(9),r=i(10);e.JobsService=class{constructor(){this.runtime=new r,this.jobs={},this.cronJobs=new Map}getJobs(){return this.jobs}get(t){if(!this.cronJobs.has(t))return!1;const e=this.cronJobs.get(t);return Object.assign(this.jobs[t],{running:e.running,nextDate:e.nextDate(),lastDate:e.lastDate()})}put(t){this.jobs.hasOwnProperty(t.identity)&&this.delete(t.identity),this.jobs[t.identity]=t;const e=new s.CronJob(t.time,()=>{try{this.runtime.emit("default",{identity:t.identity,output:n.execSync(t.bash).toString()})}catch(e){this.runtime.emit("error",{identity:t.identity,output:e.message}),this.stop(t.identity)}},null,t.start,t.zone);return this.cronJobs.set(t.identity,e),this.jobs.hasOwnProperty(t.identity)&&this.cronJobs.has(t.identity)}delete(t){return!this.cronJobs.has(t)||(this.cronJobs.get(t).stop(),this.cronJobs.delete(t)&&Reflect.deleteProperty(this.jobs,t))}start(t){if(!this.cronJobs.has(t))return!1;const e=this.cronJobs.get(t);return e.start(),e.running}stop(t){if(!this.cronJobs.has(t))return!1;const e=this.cronJobs.get(t);return e.stop(),e.running}}},function(t,e){t.exports=require("cron")},function(t,e){t.exports=require("child_process")},function(t,e){t.exports=require("events")},function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0});e.api=(t,e,i)=>{async function s(){return await i.add("jobs",{data:e.getJobs()})}t.post("/lists",{schema:{body:{required:["identity"],properties:{identity:{type:"array"}}}}},async(t,i)=>{const s=t.body;i.send({error:0,data:s.identity.map(t=>e.get(t))})}),t.post("/get",{schema:{body:{required:["identity"],properties:{identity:{type:"string"}}}}},async(t,i)=>{const s=t.body,n=e.get(s.identity);n?i.send({error:0,data:n}):i.send({error:1,msg:"not exists"})}),t.post("/put",{schema:{body:{required:["identity","time","bash","start","zone"],properties:{identity:{type:"string"},time:{type:"string"},bash:{type:"string"},start:{type:"boolean"},zone:{type:"string"}}}}},async(t,n)=>{const r=t.body,o=e.put(r),a=await i.logging({type:"put",identity:r.identity,response:r,status:o,create_time:(new Date).getTime()}),u=await s();o&&a.ok&&u.ok?n.send({error:0,msg:"ok"}):n.send({error:1,msg:"failed"})}),t.post("/delete",{schema:{body:{required:["identity"],properties:{identity:{type:"string"}}}}},async(t,n)=>{const r=t.body,o=e.delete(r.identity),a=await i.logging({type:"delete",identity:r.identity,response:r,status:o,create_time:(new Date).getTime()}),u=await s();o&&a.ok&&u.ok?n.send({error:0,msg:"ok"}):n.send({error:1,msg:"failed"})}),t.post("/status",{schema:{body:{required:["identity","status"],properties:{identity:{type:"string"},status:{type:"boolean"}}}}},async(t,s)=>{const n=t.body;n.status?e.start(n.identity):e.stop(n.identity),(await i.logging({type:"status",identity:n.identity,response:n,status:!0,create_time:(new Date).getTime()})).ok?s.send({error:0,msg:"ok"}):s.send({error:1,msg:"failed"})}),t.post("/logging",{schema:{body:{required:["type","identity","limit","skip"],properties:{type:{type:"string",enum:["put","delete","status","run","error"]},identity:{type:"string"},limit:{type:"number",minimum:1,maximum:50},skip:{type:"number",minimum:1}}}}},async(t,e)=>{const s=t.body,n=await i.find(s.type,s.identity,s.limit,s.skip);e.send({error:0,data:n})})}}]);